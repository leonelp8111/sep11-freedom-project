<!DOCTYPE html>
<html>
    <head>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" />
        <script type="module">

            // import kaboom lib
            import kaboom from "https://unpkg.com/kaboom@3000.0.1/dist/kaboom.mjs";


kaboom({
width:1800,
  height:1100,

})
// loadSprite("bg", "sprites/space.png")
loadSprite("spiderman", "sprites/spiderman.jpeg")
loadSprite("block", "sprites/marioblock.jpeg")
loadSprite("spike", "/sprites/spike.png")
loadSprite("coin", "/sprites/coin.png")
loadSound("score", "/sounds/score.mp3")
loadSprite("alien", "/sprites/alien.jpg")
loadSprite("portal", "/sprites/portal.png")

// add([
//   sprite("bg", { width: 1800, height: 1100 })
// ])

const SPEED = 480
const FALL_DEATH = -100
const ENEMY_SPEED = 160
setGravity(1000)
const BULLET_SPEED = 1200

function patrol(speed = 60, dir = 1) {
  return {
    id: "patrol",
    require: [ "pos", "area" ],
    add() {
      this.on("collide", (obj, col) => {
        if (col.isLeft() || col.isRight()) {
          dir = -dir
        }
      })
    },
    update() {
      this.move(speed * dir, 0)
    },
  }
}


const LEVELS = [
      [ "=========================================",
        "                     =                  =",
        "                     =                  =",
        "                     =                  =",
        "                     =                  =",
        "                     =                  =",
        "                     =                  =",
        "                                        =",
        "                                        =",
        "@  ^^  $$     $>   $    ^   $$       > >  0",
        "=========  ======  ===========  ===========",
      ],
       [
         "=========================================",
           "                     =                  =",
           "                     =                  =",
           "                     =                  =",
           "                     =                  =",
           "                     =                  =",
           "                     =                  =",
           "                                        =",
           "                                        =",
           "@  ^^  $$     $>   $    ^   $$       > >  0",
           "=========  ======  ===========  ===========",,
       ],
  ]
   scene("game", ({ levelIdx, score }) => {

  const level = addLevel(LEVELS[levelIdx || 0],{

        tileWidth: 110,
        tileHeight: 110,
        tiles: {
          "@": () => [
            sprite("spiderman"),
            scale(.2),
            area(),
            body(),
            anchor("bot"),
            "spider",
          ],
          "=": () => [
            sprite("block"),
            area(),
            body({ isStatic: true }),
            anchor("bot"),
            scale(0.3),
          ],
          "^": () => [
            sprite("spike"),
            area({scale:0.5}),
            anchor("bot"),
            "danger",
            scale(0.2),
          ],
          "$": () => [
            sprite("coin"),
            area(),
            anchor("bot"),
            "coin",
            scale(0.2),
          ],
          ">": () => [
            sprite("alien"),
            area(),
            anchor("bot"),
            body(),
            patrol(),
            offscreen({ hide: true }),
            "enemy",
          ],
          "0": () => [
            sprite("portal"),
            area(),
            anchor("bot"),
            body(),
            offscreen({ hide: true }),
            "portal",
          ],
        },
      })

      const spider = level.get("spider")[0]
      const alien = level.get("enemy")[0]
      // Movements
      onKeyPress("w", () => {
        if (spider.isGrounded()) {
          spider.jump()
        }
      })

      onKeyDown("a", () => {
        spider.move(-SPEED, 0)
      })

      onKeyDown("d", () => {
        spider.move(SPEED, 0)
      })

      spider.onCollide("danger", () => {
        spider.pos = level.tile2Pos(0, 8)
        go("lose")
      })

      spider.onCollide("coin", (coin) => {
        destroy(coin)
        play("score")
        score++
        scoreLabel.text = score
      })


      spider.onCollide("enemy", (enemy) =>{
        // spider.pos = level.tile2Pos(0, 8)
        go("lose")
      });

      const scoreLabel = add([
        text(score),
        pos(12),
      ])

      spider.onUpdate(() => {
        camPos(spider.pos)
      })

onKeyPress("m", () => {
        // spawnBullet(spider.pos.sub(16, 0))
        spawnBullet(spider.pos.add(16, 0))
      })

alien.onCollide("bullet", (bullet) => {
  destroy(bullet)
  destroy(alien)
  addKaboom(bullet.pos)
})


})

  scene("lose", () => {

        add([
          text("You Lose"),
          pos(12),
        ])
      })





      function spawnBullet(p) {
        add([
          rect(12, 10),
          area(),
          pos(p),
          anchor("center"),
          color(127, 127, 255),
          outline(2),
          move(RIGHT, BULLET_SPEED),
          offscreen({ destroy: true }),
          "bullet",
        ])
      }







            </script>
        <style>
            /* CSS */

        </style>

        <title>Kaboom</title>
    </head>
    <body>
        <!-- HTML -->


        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            // JS


        </script>
    </body>
</html>
